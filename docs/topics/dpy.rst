.. _dpy:

=====================
The Python serializer
=====================

Lino's Python serializer and deserializer is defined in the the
:mod:`lino.utils.dpy` module.

It is used for backing and migrate databases (see :doc:`/dev/dump2py`)
and for loading :doc:`Python fixtures </tutorials/dumpy>`.

Note the difference between "intelligent" and "dumped" fixtures:

- An **intelligent fixture** is written by a human. 
  You use them to provide demo data to a Lino application.

  See :doc:`Python fixtures </tutorials/dumpy>`.

- A **dumped fixture** is generated by the :command:`dumpdata` or
  :command:`dump2py` command and looks much less readable because it is
  optimized to allow automated database migrations.

  See :doc:`/dev/dump2py`.
  
 

How it works
------------
  
When a Lino application starts up, it sets your `SERIALIZATION_MODULES
<https://docs.djangoproject.com/en/dev/ref/settings/#serialization-modules>`_
setting to `{"py" : "lino.utils.dpy"}`.  This tells Django to
associate the `.py` ending to the :class:`lino.utils.dpy.Deserializer`
class when loading ("deserializing") fixtures.

The :class:`lino.utils.dpy.Deserializer` expects every Python fixture
to define a global function `objects` which it expects to return (or
`yield
<http://stackoverflow.com/questions/231767/the-python-yield-keyword-explained>`_)
the list of model instances to be added to the database.

Vocabulary:

- a *serializer* is run by the 
  `dumpdata <https://docs.djangoproject.com/en/dev/ref/django-admin/#dumpdata-appname-appname-appname-model>`_ 
  command and 
  dumps data into a file which can be  used as a fixture.
  
- a *deserializer* is run by 
  `loaddata <https://docs.djangoproject.com/en/dev/ref/django-admin/#django-admin-loaddata>`_ 
  and loads fixtures into the database.
  
  
Note that you cannot use relative imports in a Python fixture.
See `here 
<http://stackoverflow.com/questions/4907054/loading-each-py-file-in-a-path-imp-load-module-complains-about-relative-impor>`__


Discussion
----------
  
Concept and implementation of Python fixtures is fully the author's
work, and we didn't yet find a similar approach in any other
framework.  But the basic idea of using Python language to describe
data collections is of course not new.

- For example Limodou published a Djangosnippet in 2007 which does
  something similar: `db_dump.py - for dumpping and loading data from
  database <http://djangosnippets.org/snippets/14/>`_.

- http://code.djangoproject.com/ticket/10664

